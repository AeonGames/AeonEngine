name: Build on Windows

on: [push, pull_request]

env:
  USERNAME: AeonGames
  VCPKG_EXE: C:\vcpkg\vcpkg.exe
  FEED_URL: https://nuget.pkg.github.com/AeonGames/index.json
  VCPKG_BINARY_SOURCES: "clear;nuget,https://nuget.pkg.github.com/AeonGames/index.json,readwrite;nugettimeout,900"
  VCPKG_FEATURE_FLAGS: "binarycaching,manifests,versions"
  VCPKG_VERBOSE: "1"

jobs:
  build:
    runs-on: windows-latest
    permissions:
      contents: read
      packages: write
      id-token: write

    strategy:
      matrix:
        compiler: [msvc]

    steps:
    - name: ğŸ§° Checkout
      uses: actions/checkout@v2

    - name: ğŸ”„ Update Visual Studio
      shell: pwsh
      run: |
        & "${env:ProgramFiles(x86)}\Microsoft Visual Studio\Installer\vs_installer.exe" update --installPath "${env:ProgramFiles}\Microsoft Visual Studio\2022\Enterprise" --quiet --wait
      if: matrix.compiler == 'msvc'

    - name: ğŸ”ƒ Update VCPKG
      shell: pwsh
      run: |
        cd C:\vcpkg
        git pull
        .\bootstrap-vcpkg.bat
      if: matrix.compiler == 'msvc'

    - name: ğŸ“¦ Add NuGet sources
      shell: pwsh
      run: |
        .$(${{ env.VCPKG_EXE }} fetch nuget) `
          sources add `
          -Source "${{ env.FEED_URL }}" `
          -StorePasswordInClearText `
          -Name GitHubPackages `
          -UserName "${{ env.USERNAME }}" `
          -Password "${{ secrets.PAT }}"
        .$(${{ env.VCPKG_EXE }} fetch nuget) `
          setapikey "${{ secrets.PAT }}" `
          -Source "${{ env.FEED_URL }}"
      if: matrix.compiler == 'msvc'

    - name: âš™ï¸ Configure CMake (Windows Visual Studio)
      shell: pwsh
      run: |
        cmake -DCMAKE_TOOLCHAIN_FILE="C:\vcpkg\scripts\buildsystems\vcpkg.cmake" -B ${{github.workspace}}/build
      if: matrix.compiler == 'msvc'

    - name: ğŸ”¨ Build
      run: cmake --build ${{github.workspace}}/build

    - name: ğŸ”‘ Compute vcpkg manifest hash
      id: vcpkg-hash
      shell: pwsh
      run: |
        $hash = (Get-FileHash -Algorithm SHA256 -InputStream (
          [IO.MemoryStream]::new(
            [Text.Encoding]::UTF8.GetBytes(
              (Get-Content vcpkg.json -Raw) + (Get-Content vcpkg-configuration.json -Raw)
            )
          )
        )).Hash.Substring(0, 16).ToLower()
        echo "VCPKG_HASH=$hash" >> $env:GITHUB_OUTPUT
        echo "Manifest hash: $hash"
      if: matrix.compiler == 'msvc'

    - name: ğŸ” Check if NuGet package version exists
      id: nuget-check
      shell: pwsh
      run: |
        $version = "83.68.75-${{ steps.vcpkg-hash.outputs.VCPKG_HASH }}"
        $url = "https://api.nuget.org/v3-flatcontainer/aeonengine/$version/aeonengine.nuspec"
        try {
          $response = Invoke-WebRequest -Uri $url -Method Head -ErrorAction Stop
          echo "Package aeonengine@$version already exists on nuget.org, skipping upload."
          echo "EXISTS=true" >> $env:GITHUB_OUTPUT
        } catch {
          echo "Package aeonengine@$version not found on nuget.org, will upload."
          echo "EXISTS=false" >> $env:GITHUB_OUTPUT
        }
      if: matrix.compiler == 'msvc'

    - name: ğŸ“¤ Export vcpkg packages as NuGet
      if: matrix.compiler == 'msvc' && steps.nuget-check.outputs.EXISTS == 'false'
      shell: pwsh
      run: |
        ${{ env.VCPKG_EXE }} export --x-all-installed --nuget `
          --nuget-id=AeonEngine `
          --nuget-version="83.68.75-${{ steps.vcpkg-hash.outputs.VCPKG_HASH }}" `
          --nuget-description="AeonEngine vcpkg dependencies" `
          --output-dir=${{github.workspace}}/nupkg

    - name: ğŸ” NuGet login (OIDC trusted publishing)
      if: matrix.compiler == 'msvc' && steps.nuget-check.outputs.EXISTS == 'false'
      uses: NuGet/login@v1
      id: nuget-login
      with:
        user: kwizatz

    - name: ğŸ“¦ Push to nuget.org
      if: matrix.compiler == 'msvc' && steps.nuget-check.outputs.EXISTS == 'false'
      shell: pwsh
      run: |
        dotnet nuget push "${{github.workspace}}/nupkg/*.nupkg" `
          --api-key ${{ steps.nuget-login.outputs.NUGET_API_KEY }} `
          --source https://api.nuget.org/v3/index.json `
          --skip-duplicate

    - name: ğŸ§ª Run Tests
      shell: pwsh
      run: |
        cd ${{github.workspace}}/build
        ctest --output-on-failure --verbose -C Debug
      if: matrix.compiler == 'msvc'