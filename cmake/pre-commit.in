#!/bin/sh

if git rev-parse --verify HEAD >/dev/null 2>&1
then
	against=HEAD
else
	# Initial commit: diff against an empty tree object
	against=4b825dc642cb6eb9a060e54bf8d69288fbee4904
fi

FILES=`git diff --cached $against --name-only --diff-filter=ACMR | grep -E "\.(c|cpp|h|hpp)$"`
for FILE in $FILES; do
	${ASTYLE_EXECUTABLE} ${ASTYLE_OPTIONS} < $FILE | cmp -s $FILE -
	if [ $? -ne 0 ]; then
		echo "[!] $FILE does not respect coding style," >&2
		echo "[!] please build the 'format-code' target." >&2
		echo "[!] For example make format-code" >&2
		exit 1
	fi
done
